library(sf)
library(spdep)
library(leaflet)
library(dplyr)
library(htmltools)
library(tidyverse)
library(htmlwidgets)
library(rmapshaper)
library(glue)
library(viridis)
library(cleangeo)

# read in city boundaries
city_boundaries <- st_read("./data/city_boundaries/city_boundaries.shp") %>%
  st_transform(4326)

# read in social vulnerability index data cdc - available at https://www.atsdr.cdc.gov/placeandhealth/svi/data_documentation_download.html
md_tracts_svi <- st_read("./data/maryland_svi_2018/SVI2018_MARYLAND_tract.shp") %>%
  rename_all(tolower) %>%
  separate(location, into = c("tract_full", NA, NA), sep = ",", remove = F)

# recode vars based on dictionary - https://www.atsdr.cdc.gov/placeandhealth/svi/documentation/pdf/SVI2018Documentation-H.pdf
percentage_vars <- c("ep_pov", "ep_unemp", "ep_pci", "ep_nohsdp", "ep_age65", "ep_age17", "ep_disabl", "ep_sngpnt", "ep_minrty", "ep_limeng", "ep_munit", "ep_mobile", "ep_crowd", "ep_noveh", "ep_groupq")

pctile_vars <- map_chr(percentage_vars, ~ gsub("ep_", "epl_", .x))

flag_vars <- map_chr(percentage_vars, ~ gsub("ep_", "f_", .x))

theme_vars <- c("spl_theme1", "spl_theme2", "spl_theme3", "spl_theme4", "spl_themes")

theme_vars_pctile <- map_chr(theme_vars, ~ gsub("spl_", "rpl_", .x))

theme_vars_flags <- c(map_chr(theme_vars[-5], ~ gsub("spl_", "f_", .x)), "f_total")

# combine variables of interest want to keep
vars_combined <- c(percentage_vars, pctile_vars, flag_vars, theme_vars, theme_vars_pctile, theme_vars_flags)

# filter to montgomery county and variables of interest
mc_tracts_svi <- md_tracts_svi %>%
  filter(grepl("Montgomery", county)) %>%
  select(st, county, tract_full, fips, location, e_totpop, e_hu, e_hh, all_of(vars_combined))

# define tracts in takoma park - corresponding consulting group hced plan
tp_tracts <- c("701800", "701704", "701701", "701702", "701703")

# function to make percent vars out of 100 and 2 decimals
pct_round <- function(pct_value){
  return(round(pct_value*100, 2))
}

# pull tract from fip code and filter to tp tracts
tp_tracts_svi <- mc_tracts_svi %>%
  st_transform(4326) %>%
  mutate(tract = str_sub(fips, -6, -1)) %>%
  filter(tract %in% tp_tracts) %>%
  mutate(
         # per census documentation - set -999 to NA, which represent missing values or 0 popultaion tracts (https://www.atsdr.cdc.gov/placeandhealth/svi/documentation/pdf/SVI2018Documentation-H.pdf):
         # Tracts with zero estimates for total population (N = 645 for the U.S.) were removed during the ranking
         # process. These tracts were added back to the SVI databases after ranking. The TOTPOP field value is 0,
         # but the percentile ranking fields (RPL_THEME1, RPL_THEME2, RPL_THEME3, RPL_THEME4, and
         #                                    RPL_THEMES) were set to -999.
         #  For tracts with > 0 TOTPOP, a value of -999 in any field either means the value was unavailable from the
         # original census data or we could not calculate a derived value because of unavailable census data.
         #  Any cells with a -999 were not used for further calculations. For example, total flags do not include fields
         # with a -999 value.
         across(.cols = where(is.numeric), .fns = ~ ifelse(.x == -999, NA, .x)),
         # apply percent function to percent vars
         across(.cols = all_of(c(pctile_vars, theme_vars_pctile)), .fns = pct_round))

# create a dataset without geometry
tp_as_data <- tp_tracts_svi %>%
  st_drop_geometry

### define palette functions
# one to color based on range of percent values
pal_numeric <- function(var, colors, df = tp_as_data, reverse = FALSE) {
  colorNumeric(palette = colors, domain = df[[var]], reverse = reverse)
}

# define list of colors corresponding to each theme of social vulnerability
colors_select <- list("overall" = "RdPu", "socioeconomic" = "Greens", "households" = "Oranges", "minority" = "Blues", "housing" = "Purples")

# function for percentiles
pal_pctile <- function(colors){
  colorBin(palette = colors, domain = c(0, 100), bins = seq(0, 100, 10))
}

# define common labels
labels_funct <- function(df_as_data){
  map(seq(nrow(df_as_data)), function(i){
    return(paste0(
      df_as_data[i, "tract_full"], ", ", df_as_data[i, "e_hh"], " households", '<p></p>',
      "Percentile social vulnerability in Maryland: ", df_as_data[i, "rpl_themes"], '<p></p>',
      "Percentile socioeconomic component: ", df_as_data[i, "rpl_theme1"], '<p></p>',
      "Percentile household/disability component: ", df_as_data[i, "rpl_theme2"], '<p></p>',
      "Percentile minority status/language component: ", df_as_data[i, "rpl_theme3"], '<p></p>',
      "Percentile housing type/transportation component: ", df_as_data[i, "rpl_theme4"]))
  })
}

### Define 
addpoly_standard <- function(basemap,  
                             df, 
                             pal_funct, 
                             variable, 
                             group, 
                             title, 
                             labels){
  basemap %>%
    addPolygons(color = "transparent",
                weight = 1, 
                opacity = 1, 
                fillOpacity = 0.4,
                fillColor = ~ pal_funct(df[[variable]]),
                group = group, 
                highlight = highlightOptions(stroke = TRUE,
                                             weight = 3.5, 
                                             fillOpacity = 0.6, 
                                             color = "#555EE7", 
                                             opacity = 1, 
                                             bringToFront = TRUE),
                label = map(labels, htmltools::HTML),
                options = pathOptions(pane = "polygons"),
                labelOptions = labelOptions(
                  style = list("font-weight" = "normal", 
                               padding = "1px 1px"),
                  textsize = "11px",
                  direction = "auto", 
                  opacity = 0.8))
}

addlegend_standard <- function(basemap, df, pal_funct, variable, group, title){
  basemap %>%
    addLegend("topright", 
              pal = pal_funct, 
              values = ~ df[[variable]], 
              opacity = 0.7, 
              group = group, 
              title = title)
}

addpoly_legend <- function(basemap_select, df_select = tp_as_data, pal_funct_select, variable_select, group_select, title_select = "Percent", labels_select){
  
  basemap_select %>%
    addpoly_standard(df_select, pal_funct_select, variable_select, group_select, labels = labels_select) %>%
    addlegend_standard(df_select, pal_funct_select, variable_select, group_select, title_select)
}

# find map centroid
tp_tracts_centroid <- tp_tracts_svi %>%
  st_centroid

# ## flood data - maryland - https://msc.fema.gov/portal/advanceSearch
md_flood <- st_read("./data/NFHL_24_20200624.gdb", layer = "S_FLD_HAZ_AR") %>%
  filter(!grepl("X", FLD_ZONE)) %>%
  # st_cast("MULTIPOLYGON") %>%
  st_make_valid() %>%
  st_transform(4326)

# define lookup codes for fema based on 
lookup_fld_codes <- list("A" = "1% or greater annual chance of flooding",
                         "AE" = "1% or greater annual chance of flooding",
                         "AH" = "1% or greater annual chance of shallow flooding",
                         "AO" = "1% or greater annual chance of shallow flooding",
                         "AR" = "Short-term 1% or greater annual chance of flooding",
                         "A99" = "Short-term 1% or greater annual chance of flooding",
                         "V" = "Coastal area with wave hazards and 1% or greater annual chance of flooding",
                         "VE" = "Coastal area with wave hazards and 1% or greater annual chance of flooding",
                         "D" = "Undetermined flood hazard where flooding possible")

lookup_fld <- data.frame(code = names(lookup_fld_codes), description = unlist(lookup_fld_codes, use.names = FALSE))

# flood data - montgomery county
mc_flood_process <- st_read("./data/nfhl_montgomery_county/S_FLD_HAZ_AR.shp") %>%
  # st_cast("MULTIPOLYGON") %>%
  st_make_valid() %>%
  st_transform(4326) %>%
  # filter out non-floodzones
  filter(!grepl("X", FLD_ZONE))


factor_color_fld <- function(flood_df, flood_var){
  colorFactor(viridis(length(unique(flood_df[[flood_var]])), 
                      # direction = -1, 
                      option = "B") , 
              domain = flood_df[[flood_var]])
}

add_flood_poly <- function(basemap, 
                           flood_df, 
                           flood_df_as_data,
                           flood_var,
                           pal_funct, 
                           labels){

  basemap %>%
    addPolygons(fill = TRUE,
                fillColor = ~ pal_funct(flood_df_as_data[[flood_var]]), 
                stroke = TRUE,
                weight = 1,
                opacity = 0.6,
                fillOpacity = 0.55,
                group = "Flood Zones", 
                label = map(labels, htmltools::HTML),
                highlightOptions = highlightOptions(stroke = TRUE,
                                 weight = 3, 
                                 fillOpacity = 0.6, 
                                 color = "blue", 
                                 opacity = 1, 
                                 bringToFront = TRUE), 
                labelOptions = labelOptions(
                  style = list("font-weight" = "normal", 
                               padding = "1px 1px"),
                  textsize = "11px",
                  direction = "auto", 
                  opacity = 0.8),
                data = flood_df)
}

add_flood_legend <- function(basemap, 
                             flood_df, 
                             flood_df_as_data,
                             flood_var,
                             pal_funct, 
                             title) {
  basemap %>%
    addLegend("topright", 
              pal = pal_funct, 
              values = ~ flood_df_as_data[[flood_var]], 
              opacity = 0.7, 
              group = "Flood Zones", 
              title = title)
}

add_flood_poly_legend <- function(basemap, 
                                  flood_df,
                                  flood_df_as_data,
                                  flood_var,
                                  labels,
                                  title){
  
  pal_val <- factor_color_fld(flood_df = flood_df, 
                              flood_var = flood_var)
  
  return(basemap %>%
    add_flood_poly(flood_df = flood_df, 
                   flood_df_as_data = flood_df_as_data,
                   flood_var = flood_var,
                   pal_funct = pal_val,
                   labels = labels) %>%
      add_flood_legend(flood_df = flood_df,
                       flood_df_as_data = flood_df_as_data,
                       flood_var = flood_var,
                       pal_funct = pal_val,
                       title = title)
  )
}
  

fld_labels <- function(flood_df){
  map(seq(nrow(flood_df)), ~
        paste0("Flood code: ", flood_df[.x, "FLD_ZONE"], "<p></p>",
        "Flood description: ", flood_df[.x, "description"]))
}



# city function
add_city <- function(basemap){
  basemap %>%
    addPolygons(data = city_boundaries, 
                fill = FALSE,
                smoothFactor = 0.5,
                weight = 1, 
                opacity = 1,
                color = "#646464", 
                label = "Takoma Park",
                options = pathOptions(pane = "borders"),
                labelOptions = labelOptions(noHide = TRUE,
                                            direction = 'top',
                                            textOnly = TRUE,
                                            style = list("font-weight" = "bold", padding = "1px 1px"),
                                            textsize = "10.25px"))
}

# create leaflet map with overall vulnerability and components
map_funct <- function(basemap, 
                      as_data_file, 
                      city = "city",
                      flood_list = NULL,
                      collapsed_val = FALSE){
  label_result <- labels_funct(as_data_file)
  
  group_cols <- c("Social vulnerability index percentile in Maryland",
                  "Socioeconomic component percentile in Maryland",
                  "Household/disability component percentile in Maryland",
                  "Minority status/language component percentile in Maryland",
                  "Housing type/transportation component percentile in Maryland",
                  "Percent persons in poverty",
                  "Unemployment rate",
                  "Per capita income",
                  "Percent persons without HS diploma",
                  "Percent persons over age 65",
                  "Percent persons under 17",
                  "Percent persons with a disability",
                  "Percent single parent households with children under 18",
                  "Percent persons of color",
                  "Percent persons with limited English proficiency",
                  "Percent housing in structures with 10 or more units",
                  # "Percent mobile homes",
                  "Percent housing with more people than rooms",
                  "Percent households without vehicle",
                  "Percent persons in group quarters")
  
  map <- leaflet(basemap) %>%
    addTiles(options = tileOptions(opacity = 0.5)) %>%
    addMapPane("borders", zIndex = 420) %>%
    addMapPane("polygons", zIndex = 410) %>%
    addpoly_legend(as_data_file, pal_numeric("rpl_themes", df = as_data_file, colors_select[[1]]), "rpl_themes", "Social vulnerability index percentile in Maryland", "Percentile", labels_select = label_result) %>%
    addpoly_legend(as_data_file, pal_numeric("rpl_theme1",df = as_data_file,  colors_select[[2]]), "rpl_theme1", "Socioeconomic component percentile in Maryland", "Percentile", labels_select = label_result) %>%
    addpoly_legend(as_data_file, pal_numeric("rpl_theme2",df = as_data_file,  colors_select[[3]]), "rpl_theme2", "Household/disability component percentile in Maryland", "Percentile", labels_select = label_result) %>%
    addpoly_legend(as_data_file, pal_numeric("rpl_theme3",df = as_data_file,  colors_select[[4]]), "rpl_theme3", "Minority status/language component percentile in Maryland", "Percentile", labels_select = label_result) %>%
    addpoly_legend(as_data_file, pal_numeric("rpl_theme4",df = as_data_file,  colors_select[[5]]), "rpl_theme4", "Housing type/transportation component percentile in Maryland", "Percentile", labels_select = label_result) %>%
    addpoly_legend(as_data_file, pal_numeric("ep_pov", df = as_data_file, colors_select[[2]]), "ep_pov", "Percent persons in poverty", "Percent", labels_select = label_result) %>%
    addpoly_legend(as_data_file, pal_numeric("ep_unemp", df = as_data_file, colors_select[[2]]), "ep_unemp", "Unemployment rate", labels_select = label_result) %>%
    addpoly_legend(as_data_file, pal_numeric("ep_pci", df = as_data_file, colors_select[[2]], reverse = TRUE), "ep_pci", "Per capita income", "Income", labels_select = label_result) %>%
    addpoly_legend(as_data_file, pal_numeric("ep_nohsdp", df = as_data_file, colors_select[[2]]), "ep_nohsdp", "Percent persons without HS diploma", labels_select = label_result) %>%
    addpoly_legend(as_data_file, pal_numeric("ep_age65", df = as_data_file, colors_select[[3]]), "ep_age65", "Percent persons over age 65", labels_select = label_result) %>%
    addpoly_legend(as_data_file, pal_numeric("ep_age17", df = as_data_file, colors_select[[3]]), "ep_age17", "Percent persons under 17", labels_select = label_result) %>%
    addpoly_legend(as_data_file, pal_numeric("ep_disabl", df = as_data_file, colors_select[[3]]), "ep_disabl", "Percent persons with a disability", labels_select = label_result) %>%
    addpoly_legend(as_data_file, pal_numeric("ep_sngpnt", df = as_data_file, colors_select[[3]]), "ep_sngpnt", "Percent single parent households with children under 18", labels_select = label_result) %>%
    addpoly_legend(as_data_file, pal_numeric("ep_minrty", df = as_data_file, colors_select[[4]]), "ep_minrty", "Percent persons of color", labels_select = label_result) %>%
    addpoly_legend(as_data_file, pal_numeric("ep_limeng", df = as_data_file, colors_select[[4]]), "ep_limeng", "Percent persons with limited English proficiency", labels_select = label_result) %>%
    addpoly_legend(as_data_file, pal_numeric("ep_munit", df = as_data_file, colors_select[[5]]), "ep_munit", "Percent housing in structures with 10 or more units", labels_select = label_result) %>%
    # addpoly_legend(as_data_file, pal_numeric("ep_mobile", colors_select[[5]]), "ep_mobile", "Percent mobile homes") %>%
    addpoly_legend(as_data_file, pal_numeric("ep_crowd",df = as_data_file,  colors_select[[5]]), "ep_crowd", "Percent housing with more people than rooms", labels_select = label_result) %>%
    addpoly_legend(as_data_file, pal_numeric("ep_noveh", df = as_data_file, colors_select[[5]]), "ep_noveh", "Percent households without vehicle", labels_select = label_result) %>%
    addpoly_legend(as_data_file, pal_numeric("ep_groupq", df = as_data_file, colors_select[[5]]), "ep_groupq", "Percent persons in group quarters", labels_select = label_result)

  if(city == "city"){
    map <- map %>%
      add_city()
  }
  
  if (!is.null(flood_list)){
    
    group_cols <- c(group_cols,
                    "Flood Zones")
    
    flood_df <- flood_list[["flood_df"]] %>%
      left_join(lookup_fld, by = c("FLD_ZONE" = "code"))
    
    flood_df_asdata <- flood_df %>%
      st_drop_geometry()
    
    fld_label <- fld_labels(flood_df_asdata)
    # browser()

    # add flood data to map if including
    map <- map %>%
      add_flood_poly_legend(flood_df  = flood_df,
                            flood_df_as_data = flood_df_asdata,
                            flood_var = "description", 
                            labels = fld_label,
                            title = flood_list[["title"]])
  }
  
  return(map %>%
           addLayersControl(overlayGroups = group_cols, 
                            options = layersControlOptions(collapsed = collapsed_val)) %>%
           hideGroup(group_cols[-1]))
  
}

# intersect and subset flood data with tp tracts data
tp_flood <- mc_flood_process[map_lgl(st_intersects(mc_flood_process, tp_tracts_svi, sparse = TRUE), ~ length(.x) > 0), ]

flood_list_default <- list("flood_df" = mc_flood_process,
                           "title" = "Flood zone")

# tp map with city boundaries
map_tp_tracts_noward <- map_funct(tp_tracts_svi, tp_as_data, city = "city")

# intersect and subset flood data with tp tracts data
tp_flood <- mc_flood_process[map_lgl(st_intersects(mc_flood_process, tp_tracts_svi, sparse = TRUE), ~ length(.x) > 0), ]

map_tp_tracts_fld <- map_funct(tp_tracts_svi, tp_as_data, flood_list = list("flood_df" = tp_flood, "title" = "Flood zone"), collapsed_val = TRUE)

saveWidget(map_tp_tracts_noward, file = "./maps/cdc_social_vulnerability_2018_takomapark_noward.html")

saveWidget(map_tp_tracts_fld, 
           file = "./maps/cdc_social_vulnerability_2018_takomapark_floodzones.html")

## montgomery county
mc_tracts_svi_processed <- mc_tracts_svi %>%
  st_transform(4326) %>%
  mutate(
    # per census documentation - set -999 to NA, which represent missing values or 0 popultaion tracts (https://www.atsdr.cdc.gov/placeandhealth/svi/documentation/pdf/SVI2018Documentation-H.pdf):
    # Tracts with zero estimates for total population (N = 645 for the U.S.) were removed during the ranking
    # process. These tracts were added back to the SVI databases after ranking. The TOTPOP field value is 0,
    # but the percentile ranking fields (RPL_THEME1, RPL_THEME2, RPL_THEME3, RPL_THEME4, and
    #                                    RPL_THEMES) were set to -999.
    #  For tracts with > 0 TOTPOP, a value of -999 in any field either means the value was unavailable from the
    # original census data or we could not calculate a derived value because of unavailable census data.
    #  Any cells with a -999 were not used for further calculations. For example, total flags do not include fields
    # with a -999 value.
    across(.cols = where(is.numeric), .fns = ~ ifelse(.x == -999, NA, .x)),
    # apply percent function to percent vars
    across(.cols = all_of(c(pctile_vars, theme_vars_pctile)), .fns = pct_round))

# # load in montgomery county communities data
# communities <- st_read("./data/Communities.shp")

# md_municipal <- st_read("./data/Maryland_Political_Boundaries_-_Municipal_Boundaries.shp")


### generate maps montgomery county
map_mc_tracts_noward <- map_funct(mc_tracts_svi_processed, as_data_file = mc_tracts_svi_processed %>% st_drop_geometry, "city") 

map_mc_tracts_fld <- map_funct(basemap = mc_tracts_svi_processed, 
                               as_data_file = mc_tracts_svi_processed %>% st_drop_geometry, 
                               TRUE, 
                               collapsed_val = TRUE,
                               flood_list = flood_list_default)

saveWidget(map_mc_tracts_noward, file = "./maps/cdc_social_vulnerability_2018_montgomerycounty_noward.html")

saveWidget(map_mc_tracts_fld, file = "./maps/cdc_social_vulnerability_2018_montgomerycounty_floodzones.html")

### maryland
md_tracts_svi_processed <- md_tracts_svi %>%
  select(st, county, fips, tract_full, location, e_totpop, e_hu, e_hh, all_of(vars_combined)) %>%
  st_transform(4326) %>%
  mutate(
    # per census documentation - set -999 to NA, which represent missing values or 0 popultaion tracts (https://www.atsdr.cdc.gov/placeandhealth/svi/documentation/pdf/SVI2018Documentation-H.pdf):
      # Tracts with zero estimates for total population (N = 645 for the U.S.) were removed during the ranking
      # process. These tracts were added back to the SVI databases after ranking. The TOTPOP field value is 0,
      # but the percentile ranking fields (RPL_THEME1, RPL_THEME2, RPL_THEME3, RPL_THEME4, and
      #                                    RPL_THEMES) were set to -999.
      #  For tracts with > 0 TOTPOP, a value of -999 in any field either means the value was unavailable from the
      # original census data or we could not calculate a derived value because of unavailable census data.
      #  Any cells with a -999 were not used for further calculations. For example, total flags do not include fields
      # with a -999 value.
    across(.cols = where(is.numeric), .fns = ~ ifelse(.x == -999, NA, .x)),
    # apply percent function to percent vars
    across(.cols = all_of(c(pctile_vars, theme_vars_pctile)), .fns = pct_round))

numeric_cols_md <- select(md_tracts_svi_processed %>% st_drop_geometry(), where(is.numeric))

# confirm makes sense
map2(numeric_cols_md, colnames(numeric_cols_md), ~ {
  range_vector <- range(.x, na.rm = TRUE)
  
  if (range_vector[1] < 0){
    stop("error; negative values in range vector")
  }
  
  if (range_vector[2] > 100 & .y %in% c(pctile_vars, percentage_vars[percentage_vars != "ep_pci"], theme_vars_pctile)){
    stop(glue("error; max value of a {.y} column exceeds 100"))
  }
  return(range_vector)

})

### maps for maryland
map_md_tracts <- map_funct(md_tracts_svi_processed, md_tracts_svi_processed %>% st_drop_geometry, FALSE)

saveWidget(map_md_tracts, file = "./maps/cdc_social_vulnerability_2018_maryland.html")

map_md_tracts_fld <- map_funct(md_tracts_svi_processed, md_tracts_svi_processed %>% st_drop_geometry, FALSE, collapsed_val = TRUE, flood_list = list("flood_df" = md_flood, title = "Flood zones"))

saveWidget(map_md_tracts, file = "./maps/cdc_social_vulnerability_2018_maryland_floodzones.html", selfcontained = FALSE)


